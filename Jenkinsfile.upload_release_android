// We need release builds for users who want to test apps, diawi removes old builds and limits downloads, hence the need for Artifactory.
// To see env: echo sh(returnStdout: true, script: 'env')

env.LANG="en_US.UTF-8"
env.LANGUAGE="en_US.UTF-8"
env.LC_ALL="en_US.UTF-8"

timeout(90) {
    node ('macos'){
        def apkUrl = ''
        def ipaUrl = ''
        def testPassed = true
        def version
        def build_no

        load "$HOME/env.groovy"

        try {
            stage('Git & Dependencies') {
                sendSlackNotification('good', BRANCH_NAME + ' build started. ' + env.BUILD_URL)
                gitDependencies()
            }

            stage('Tag Build') {
                buildTag()
            }

            stage('Tests') {
                sh 'lein test-cljs'
            }

            stage('Build') {
                sh 'lein prod-build'
            }

            stage('Build (Android)') {
              sh 'cd android && ./gradlew react-native-android:installArchives && ./gradlew assembleRelease -PreleaseVersion=' + version
            }

            stage('Deploy (Android)') {
              sh ('bundle exec fastlane android release')
            }

            stage('Push build tag') {
                pushTag()
            }
        } catch (e) {
            sendSlackNotification('bad', 'Release build failed uploading to the Play Market. ' + env.BUILD_URL)
            throw e
        }

        stage('Slack Notification') {
            sendSlackNotification('good', 'Release build ' + version + ' succesfully aploade to the Play Market')
        }
    }
}
