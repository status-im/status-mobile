#!/usr/bin/env bash

#
# Fix permissions in certain directories so that React Native doesn't have a fit
#
# The reasoning for a (mostly) read-only node_modules folder:
#   ideally we’d symlink the folder directly to the Nix store
#   so that we’re guaranteed to have a reproducible source.
#   Unfortunately react-native wants to build some stuff after the fact
#   and this is incompatible with the concept of a pure Nix package.
#   Therefore we copy the whole source to the repo directory,
#   allow writing only on the folders where it is absolutely required,
#   and therefore we still keep some peace of mind that the rest
#   of node_modules is unchanged the rest of the time.
#

set -Eeuo pipefail

nodeModulesDir="$STATUS_REACT_HOME/node_modules"
rndir="$nodeModulesDir/react-native"
rnabuild="$rndir/ReactAndroid/build"

trap "rm -f $nodeModulesDir/.copied~" ERR

chmod u+w -R $rnabuild
# TODO: Maybe not all of these need to be changed
chmod 744 $rndir/scripts/.packager.env \
          $rndir/ReactAndroid/build.gradle \
          $rnabuild/outputs/logs/manifest-merger-release-report.txt \
          $rnabuild/intermediates/library_manifest/release/AndroidManifest.xml \
          $rnabuild/intermediates/merged_manifests/release/output.json \
          $rnabuild/intermediates/symbols/release/R.txt \
          $rnabuild/intermediates/res/symbol-table-with-package/release/package-aware-r.txt

# If these directories are missing, there will be an error later on when building with this node_modules directory:
# What went wrong:
# Failed to create parent directory 'node_modules/react-native-touch-id/android/build' when creating directory 'node_modules/react-native-touch-id/android/build/intermediates/check_manifest_result/release/checkReleaseManifest/out'
chmod u+w $nodeModulesDir
for p in $nodeModulesDir/react-native-* \
         $nodeModulesDir/realm
do
  chmod -R u+w $p
  mkdir -p $p/android/build
done
touch $nodeModulesDir/.copied~
chmod u-w $nodeModulesDir
