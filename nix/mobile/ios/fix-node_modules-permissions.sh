#!/usr/bin/env bash

#
# Fix permissions in certain directories so that React Native doesn't have a fit
#
# The reasoning for a (mostly) read-only node_modules folder:
#   ideally we’d symlink the folder directly to the Nix store
#   so that we’re guaranteed to have a reproducible source.
#   Unfortunately react-native wants to build some stuff after the fact
#   and this is incompatible with the concept of a pure Nix package.
#   Therefore we copy the whole source to the repo directory,
#   allow writing only on the folders where it is absolutely required,
#   and therefore we still keep some peace of mind that the rest
#   of node_modules is unchanged the rest of the time.
#

set -e

nodeModulesDir="$STATUS_REACT_HOME/node_modules"
rndir="$nodeModulesDir/react-native"

trap "echo 'Invalidating node_modules directory...' && rm -f $nodeModulesDir/.copied~" ERR

chmod 744 $rndir/scripts/.packager.env \
          $rndir/Libraries/WebSocket/RCTWebSocketExecutor.m
for f in `find $nodeModulesDir -name "*.xcodeproj"`; do
  chmod u+w $f
  chmod u+w $(dirname $f)
done

for d in $rndir/third-party $nodeModulesDir/realm/vendor/realm-ios; do
  if [ -d "$d" ]; then
    chmod -R u+w $d
  else
    chmod u+w $(dirname $d) && \
      mkdir -p $d && \
      chmod -R u+w $d && \
      chmod u-w $(dirname $d)
  fi
done

chmod u+w $nodeModulesDir && \
  touch $nodeModulesDir/.copied~ && \
  chmod u-w $nodeModulesDir
